# 账户结构

![](./imgs/airdrop-design-直接分发空投-账户关系.drawio.svg)



一个全局的`singleton_manage_account`（使用单例模式），用于管理收取的费用；

每个项目方进行空投时，需要创建一个 airdrop_project_account，用于管理 mint-account 的 authority 授权；





# 使用示例代码

## 1. 初始化 `singleton_manage_account`

```typescript
    // 单例管理项目的管理员账户
  const singletonManageProjectAdminKeypair = Keypair.generate();
  const userFee = 10;
  
  // 初始化 singleton-manage-project
  const txIdInitSingletonManageProject = await airdropProvider.initSingletonManageProjectAction({
    buildType: BuildType.SendAndFinalizeTx,
    cuPrice: 1 * 10 ** 6,
    cuFactor: DEFAULT_CU_FACTOR,
    payer: GlobalPayerKeypair.publicKey,
    payerKeypair: GlobalPayerKeypair,
    manageAdmin: singletonManageProjectAdminKeypair.publicKey,
    manageAdminKeypair: singletonManageProjectAdminKeypair,
    userFee: userFee
  });
```



## 2. 创建一个 `airdrop_project_account`

```typescript
  // 空投工程账户
  const airdropProjectAccountKeypair = Keypair.generate();
  // 空投工程管理账户
  const airdropAdminKeypair = Keypair.generate();
  
  
  // 初始化一个 airdrop-project
  const txIdInitAirdropProject = await airdropProvider.initAirdropProjectAction({
    buildType: BuildType.SendAndFinalizeTx,
    cuPrice: 1 * 10 ** 6,
    cuFactor: DEFAULT_CU_FACTOR,
    payer: GlobalPayerKeypair.publicKey,
    payerKeypair: GlobalPayerKeypair,
    airdropProjectPubkey: airdropProjectAccountKeypair.publicKey,
    airdropProjectKeypair: airdropProjectAccountKeypair,
    airdropAdmin: airdropAdminKeypair.publicKey,
  });
```



## 3. 创建一个mint-account，并将其mint-authority设置为合约pda账户

```typescript
  // 准备一个 mint-account
  const mintAccountKeypair = Keypair.generate();
  const mintAuthorityPubkey = airdropProvider.findAirdropMintAuthorityAddress({
    airdropProjectPubkey: airdropProjectAccountKeypair.publicKey,
    mintAccountPubkey: mintAccountKeypair.publicKey
  });
  console.log(`mintAuthorityPubkey: ${mintAuthorityPubkey.toBase58()}`);

  const tokenDecimals = 8;
  await Token.createMint(
    connection,
    GlobalPayerKeypair,
    mintAuthorityPubkey,
    null,
    tokenDecimals,
    mintAccountKeypair,
    {
      commitment: 'finalized',
    }
  );
```



## 4. 空投， 可以使用或不使用 address-lookup-table

```typescript
// 构造空投接收者列表
      receiverInfoArray.push({
        receiver: aKeypair.publicKey,
        amount: new BN(aCount),
      });

// 构造 address-lookup-table
    const lookupTableAdminKeypair = Keypair.generate();
    const buildLookupTableResult = await airdropProvider.buildAirdropFtLookupTableAction({
      buildType: BuildType.SendAndFinalizeTx,
      cuPrice: 1 * 10 ** 6,
      cuFactor: DEFAULT_CU_FACTOR,
      payer: GlobalPayerKeypair.publicKey,
      payerKeypair: GlobalPayerKeypair,

      altAuthorityPubkey: lookupTableAdminKeypair.publicKey,
      altAuthorityKeypair: lookupTableAdminKeypair,

      airdropProjectPubkey: airdropProjectAccountKeypair.publicKey,

      mintAccountPubkey: mintAccountKeypair.publicKey,
      airdropPayerPubkey: GlobalPayerKeypair.publicKey,
    });

      const txId = await airdropProvider.doDirectAirdropFtAction({
        buildType: BuildType.SendAndFinalizeTx,
        cuPrice: 1 * 10 ** 6,
        cuFactor: DEFAULT_CU_FACTOR,
        payer: GlobalPayerKeypair.publicKey,
        payerKeypair: GlobalPayerKeypair,

        airdropProjectPubkey: airdropProjectAccountKeypair.publicKey,
        airdropAdminPubkey: airdropAdminKeypair.publicKey,
        airdropAdminKeypair: airdropAdminKeypair,

        mintAccountPubkey: mintAccountKeypair.publicKey,
        receivers: receiverInfoArray,

        addressLookupTablePubkeyArray: lookupTableAccountPubkey ? [lookupTableAccountPubkey] : undefined,
      });
```



在不使用 address-lookup-table 时，一笔tx中最多连续空投8个地址，在空投9个地址时，会因为Tx超过MTU限制而失败。

![](/home/gk/Workspace/05.Solana/01.solana-airdrop/docs/imgs/常规情况失败原因.png)



使用 address-lookup-table,是指将除了被空投地址以外涉及的地址都移入到 address-lookup-table中，从而减小空投Tx的体积。

但是，按此方式在一个Tx中最多空投10个。在连续空投11个时，会因为在一个交易中的ProgramLog太多而导致失败：

![](/home/gk/Workspace/05.Solana/01.solana-airdrop/docs/imgs/使用ALT后的失败原因.png)



## 5. 空投完成后，可以将 mint-account的 authority转移给任意指定地址

```typescript
    // 新的管理员
    const aliceMintAdminKeypair = Keypair.generate();

    // 切换管理员
    const txId = await airdropProvider.transferMintAuthorityAction({
      buildType: BuildType.SendAndFinalizeTx,
      cuPrice: 1 * 10 ** 6,
      cuFactor: DEFAULT_CU_FACTOR,
      payer: GlobalPayerKeypair.publicKey,
      payerKeypair: GlobalPayerKeypair,

      airdropProjectPubkey: airdropProjectAccountKeypair.publicKey,
      airdropAdminPubkey: airdropAdminKeypair.publicKey,
      airdropAdminKeypair: airdropAdminKeypair,

      mintAccountPubkey: mintAccountKeypair.publicKey,
      newMintAuthority: aliceMintAdminKeypair.publicKey,
    });
```



## 6. 单例账户的管理员可以提取费用(空投时需要向单例管理账户支付费用)

```typescript

```
